<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch 2025 CR Election</title>
    <!-- Load Tailwind CSS CDN for modern, responsive styling --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font setup */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for the results panel */
        #results-panel {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        .results-open {
            max-height: 500px !important; /* Arbitrary large value */
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
        }

        /* Watermark Styles */
        .watermark-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('https://raw.githubusercontent.com/kanishk2007dev/gmcbundi/3ba9bed8a9bd360ca811aec70d78953c00e24bdd/ChatGPT%20Image%20Nov%2013%2C%202025%2C%2010_38_51%20PM%20(1).svg');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 50%; /* Controls the size of the watermark */
            opacity: 0.05; /* Makes it very faint */
            z-index: 0; /* Ensures it stays behind the main content */
            pointer-events: none; /* Allows clicks to pass through */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <!-- Watermark Background Layer --><div class="watermark-background"></div>

    <!-- Main Application Container --><div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden relative z-10">
        
        <!-- Header --><header class="p-6 sm:p-8 bg-indigo-600 text-white relative">
            <!-- College Logo --><img src="https://raw.githubusercontent.com/kanishk2007dev/gmc-bundi/refs/heads/main/ChatGPT%20Image%20Nov%2013%2C%202025%2C%2010_38_51%20PM.png" 
                 alt="GMC Bundi Logo" 
                 class="absolute top-4 left-4 h-16 sm:h-20 w-auto rounded-full shadow-lg border-2 border-white"
                 onerror="this.onerror=null; this.src='https://placehold.co/80x80/ffffff/000000?text=GMC'">

            <div class="ml-24 sm:ml-28"> 
                <h2 class="text-xl sm:text-2xl font-semibold text-indigo-200 mb-1">
                    GOVERNMENT MEDICAL COLLEGE BUNDI
                </h2>
                <h1 class="text-3xl sm:text-4xl font-extrabold flex items-center">
                    <!-- Election Commission Logo --><img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Election_Commission_of_India_Logo.svg" 
                         alt="Election Commission of India Logo" 
                         class="w-10 h-10 mr-3 bg-white p-1 rounded-full shadow-lg"
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/000000?text=ECI'">
                    Batch 2025 CR Election
                </h1>
                <p class="mt-2 text-indigo-200 text-lg">Select your Class Representative. Your vote is confidential.</p>
            </div>
        </header>

        <!-- Voting Area --><main class="p-6 sm:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Candidates for CR</h2>
            
            <!-- Loading Indicator --><div id="loading-indicator" class="flex justify-center items-center h-20">
                <p class="text-indigo-600 font-semibold">Loading candidates and connecting to database...</p>
            </div>

            <!-- Candidate Grid: Adjusted to handle 4 columns on large screens --><div id="candidate-list" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4 hidden">
                <!-- Candidate Cards will be generated here by JavaScript --></div>

            <!-- Action Area / Results Toggle --><div class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center">
                <p id="voting-status" class="text-lg font-semibold text-gray-600 mb-4 sm:mb-0">
                    <span id="vote-message">Initializing...</span>
                </p>
                <button id="toggle-results-btn" onclick="toggleResults()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Show Live Results
                </button>
            </div>
            
            <!-- Results Panel --><div id="results-panel" class="mt-4 bg-blue-50 rounded-xl p-0 transition-all duration-300">
                <h3 class="text-xl font-bold text-blue-800 mb-4">Election Results (Real-Time)</h3>
                <div id="results-content" class="space-y-4">
                    <!-- Results will be displayed here --></div>
            </div>

            <!-- Info Message Box (Modal Substitute) --><div id="info-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
                    <svg id="modal-icon" class="w-12 h-12 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h4 id="modal-title" class="text-xl font-bold mt-4 text-gray-800">Vote Recorded!</h4>
                    <p id="modal-body" class="mt-2 text-gray-600"></p>
                    <button onclick="closeModal()" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Got it
                    </button>
                </div>
            </div>

        </main>
        
        <!-- Footer / Disclaimer --><footer class="p-4 bg-gray-100 text-center text-sm text-gray-500 border-t rounded-b-2xl">
            <p class="mb-1">Created by KANISHK MBBS STUNDENT AT GMC BUNDI</p>
            <p>CR Election for Batch 2025 at GMC Bundi | **LIVE DATA:** Results are pulled in real-time from Firestore. **VOTING LIMIT: 50 votes.**</p>
            <p id="user-id-display" class="mt-2 text-xs text-gray-400">Your User ID: Loading...</p>
        </footer>

    </div>

    <!-- Firebase and JavaScript Logic (Type Module for Imports) --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc, serverTimestamp, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // Uncomment to see Firebase logs

        // Global Firebase Configuration and Instances
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Variables
        let userId = null;
        let hasVoted = false;
        let votedFor = '';
        let isAuthReady = false;

        // --- NEW CONSTANT: VOTE LIMIT ---
        const VOTE_LIMIT = 50;
        document.querySelector('footer p:last-child').innerHTML += ` (Max Votes: ${VOTE_LIMIT})`;
        // ---------------------------------

        // Constants
        const CANDIDATES = [
            { id: 1, name: "MAYANK MEENA", manifesto: "Focussing on personalized academic support and mentorship programs.", color: "red-500", photo: "https://raw.githubusercontent.com/kanishk2007dev/gmc-bundi/refs/heads/main/Screenshot%202025-11-19%20203457.png" },
            { id: 2, name: "ANVESH", manifesto: "Organizing engaging extracurricular activities and boosting batch spirit.", color: "green-500", photo: "https://raw.githubusercontent.com/kanishk2007dev/gmc-bundi/refs/heads/main/Screenshot%202025-11-19%20203451.png" },
            { id: 3, name: "Shyam Sundar Kavia", manifesto: "Improving classroom infrastructure and establishing a seamless feedback channel.", color: "blue-500", photo: "https://raw.githubusercontent.com/kanishk2007dev/gmc-bundi/refs/heads/main/Screenshot%202025-11-19%20203506.png" },
            { id: 4, name: "Existing CR", manifesto: "Continuity of current initiatives and maximizing resource utilization.", color: "purple-500", photo: "https://placehold.co/100x100/ede9fe/6d28d9?text=ECR" }
        ];

        // --- CORE FIREBASE & AUTH SETUP ---

        /**
         * Signs in the user using the custom token or anonymously.
         */
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth error:", error);
                document.getElementById('vote-message').textContent = 'Error: Failed to connect to secure voting system.';
            }
        }

        /**
         * Sets up the real-time listener for authentication status.
         */
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `Your User ID: ${userId}`;
                
                // Show candidates and start listening for votes
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('candidate-list').classList.remove('hidden');

                renderCandidates();
                startRealtimeResults();
            } else {
                authenticateUser(); // Try to authenticate if not yet signed in
            }
        });

        // --- FIREBASE PATH HELPERS ---
        const getVotesCollection = () => collection(db, `artifacts/${appId}/public/data/cr_votes_2025`);
        const getUserVoteDoc = () => doc(db, `artifacts/${appId}/public/data/cr_votes_2025`, userId);

        // --- UI RENDERING FUNCTIONS ---

        /**
         * Renders candidate cards into the DOM.
         */
        function renderCandidates() {
            const listContainer = document.getElementById('candidate-list');
            listContainer.innerHTML = '';
            
            CANDIDATES.forEach(candidate => {
                const card = document.createElement('div');
                // The color classes need to be explicitly written in the HTML/CSS for Tailwind to recognize them before JS execution
                // Using dynamic classes like bg-${candidate.color} can fail if Tailwind doesn't scan the JS string.
                // For this environment, we'll risk it but ensure the button call is correct.
                card.className = `bg-white border border-${candidate.color} p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col justify-between h-full`;
                card.innerHTML = `
                    <div>
                        <img src="${candidate.photo}" alt="Photo of ${candidate.name}" class="w-20 h-20 rounded-full mx-auto mb-4 object-cover border-4 border-${candidate.color}" 
                            onerror="this.onerror=null; this.src='https://placehold.co/100x100/CCCCCC/000000?text=${candidate.name.charAt(0)}';">
                        <h3 class="text-xl font-bold text-gray-900 text-center">${candidate.name}</h3>
                        <p class="text-sm text-gray-500 text-center mb-4">Candidate #${candidate.id}</p>
                        <p class="text-gray-700 mt-2 text-center text-sm">${candidate.manifesto}</p>
                    </div>
                    <button id="vote-btn-${candidate.id}" onclick="window.castVoteWrapper(${candidate.id}, '${candidate.name}')" 
                        class="mt-6 w-full bg-${candidate.color} text-white font-semibold py-3 rounded-xl shadow-md transition duration-200 hover:bg-opacity-90 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Vote for ${candidate.name.split(' ')[0]}
                    </button>
                `;
                listContainer.appendChild(card);
            });
            updateVotingStatus();
        }

        /**
         * Updates the state and message displayed to the user based on the global state.
         */
        function updateVotingStatus() {
            const statusElement = document.getElementById('vote-message');

            if (!isAuthReady) {
                statusElement.textContent = "Connecting to voting system...";
                return;
            }

            if (hasVoted) {
                statusElement.innerHTML = `<span class="text-green-600">You have successfully voted for <strong>${votedFor}</strong>.</span>`;
            } else {
                statusElement.textContent = "Please cast your vote to proceed.";
            }
            updateVoteButtons();
        }

        /**
         * Disables all vote buttons if the user has already voted.
         */
        function updateVoteButtons() {
            CANDIDATES.forEach(candidate => {
                const button = document.getElementById(`vote-btn-${candidate.id}`);
                if (button) {
                    if (hasVoted) {
                        button.disabled = true;
                        // Use a safer way to get the primary name part
                        const firstName = candidate.name.split(' ')[0];
                        button.textContent = votedFor === candidate.name ? `VOTED (${firstName})` : 'Voted';
                        button.classList.add('bg-gray-400', 'cursor-not-allowed');
                        button.classList.remove('hover:bg-opacity-90', 'bg-red-500', 'bg-green-500', 'bg-blue-500', 'bg-purple-500'); // Clean up colors
                    } else {
                        button.disabled = false;
                        button.textContent = `Vote for ${candidate.name.split(' ')[0]}`;
                        button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        button.classList.add('hover:bg-opacity-90'); // Add hover effect back
                    }
                }
            });
        }

        // --- FIREBASE VOTING LOGIC ---

        /**
         * Checks if the current user has already cast a vote.
         * @returns {Promise<boolean>} True if the user has already voted.
         */
        async function checkUserVoteStatus() {
            if (!userId) return false;
            try {
                const voteDoc = await getDoc(getUserVoteDoc());
                if (voteDoc.exists()) {
                    hasVoted = true;
                    votedFor = voteDoc.data().candidateName;
                    return true;
                }
                return false;
            } catch (e) {
                console.error("Error checking vote status:", e);
                return false;
            }
        }

        /**
         * Simulates casting a vote (now saves to Firestore).
         * @param {number} candidateId - The ID of the candidate.
         * @param {string} candidateName - The name of the candidate.
         */
        window.castVoteWrapper = async function(candidateId, candidateName) {
            if (!isAuthReady || !userId) {
                showModal('Error', 'Voting system not ready. Please wait a moment.', 'orange');
                return;
            }

            if (await checkUserVoteStatus()) {
                showModal('Alert', `You have already cast your vote for <strong>${votedFor}</strong>.`, 'orange');
                return;
            }

            // --- VOTE LIMIT CHECK ---
            try {
                const votesSnapshot = await getDocs(getVotesCollection());
                if (votesSnapshot.size >= VOTE_LIMIT) {
                    showModal('Voting Closed', `The maximum limit of ${VOTE_LIMIT} votes has been reached. Voting is now closed.`, 'red');
                    return;
                }
            } catch (e) {
                console.error("Error checking vote limit:", e);
                showModal('Error', `Could not check vote limit. Please try again.`, 'red');
                return;
            }
            // ------------------------

            try {
                // 1. Write the vote document to the public collection (Document ID = userId)
                await setDoc(getUserVoteDoc(), {
                    candidateName: candidateName,
                    candidateId: candidateId,
                    votedAt: serverTimestamp(),
                    userId: userId 
                });

                // 2. Update local state
                hasVoted = true;
                votedFor = candidateName;

                // 3. UI Update is handled by the onSnapshot listener, but we call status update immediately
                updateVotingStatus();
                
                // 4. Show success message
                showModal('Vote Recorded!', `Thank you! Your vote for <strong>${candidateName}</strong> has been securely cast.`, 'green');

            } catch (error) {
                console.error("Error casting vote:", error);
                showModal('Error', `Failed to record vote. Please check your connection.`, 'red');
            }
        }

        // --- REALTIME RESULTS LOGIC ---

        /**
         * Sets up the real-time listener for all public votes.
         */
        function startRealtimeResults() {
            onSnapshot(getVotesCollection(), (snapshot) => {
                loadResults(snapshot.docs);
                // Also check if the current user's vote status changed
                checkUserVoteStatus().then(() => updateVotingStatus());
            }, (error) => {
                console.error("Error setting up real-time listener:", error);
                document.getElementById('results-content').innerHTML = '<p class="text-red-500 italic">Could not load live results. Check console for error.</p>';
            });
        }

        /**
         * Processes the Firestore documents and displays the aggregated vote results.
         * @param {Array<Object>} docs - Array of Firestore document snapshots.
         */
        function loadResults(docs) {
            const voteCounts = {};
            let totalVotes = 0;

            // Aggregate votes from all documents
            docs.forEach(doc => {
                const data = doc.data();
                const name = data.candidateName;
                if (name) {
                    voteCounts[name] = (voteCounts[name] || 0) + 1;
                    totalVotes++;
                }
            });
            
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '';

            if (totalVotes === 0) {
                resultsContent.innerHTML = '<p class="text-gray-500 italic">No votes have been cast yet. Be the first to vote!</p>';
                return;
            }

            // Create a sorted array of results (ensuring all candidates are listed)
            const resultsArray = CANDIDATES.map(c => ({
                name: c.name,
                votes: voteCounts[c.name] || 0,
                color: c.color
            })).sort((a, b) => b.votes - a.votes);

            resultsArray.forEach(result => {
                const percentage = totalVotes > 0 ? ((result.votes / totalVotes) * 100).toFixed(1) : 0;
                
                const resultBar = document.createElement('div');
                resultBar.className = 'flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4';
                resultBar.innerHTML = `
                    <p class="font-medium text-lg w-full sm:w-1/3 text-gray-800">${result.name}</p>
                    <div class="relative w-full sm:w-2/3 h-8 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                        <div style="width: ${percentage}%;" 
                            class="absolute top-0 left-0 h-full bg-${result.color} transition-all duration-500 ease-out">
                        </div>
                        <span class="absolute right-0 top-0 h-full flex items-center pr-3 font-bold text-white text-sm" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                            ${result.votes} Votes (${percentage}%)
                        </span>
                    </div>
                `;
                resultsContent.appendChild(resultBar);
            });
        }
        
        /**
         * Toggles the visibility of the results panel.
         */
        window.toggleResults = function() {
            const resultsPanel = document.getElementById('results-panel');
            const button = document.getElementById('toggle-results-btn');

            if (resultsPanel.classList.contains('results-open')) {
                resultsPanel.classList.remove('results-open');
                button.textContent = 'Show Live Results';
                button.classList.remove('bg-red-500');
                button.classList.add('bg-blue-500');
            } else {
                // Results are automatically loaded by the onSnapshot listener
                resultsPanel.classList.add('results-open');
                button.textContent = 'Hide Results';
                button.classList.remove('bg-blue-500');
                button.classList.add('bg-red-500');
            }
        }

        /**
         * Shows a custom modal message box.
         */
        window.showModal = function(title, body, iconColor) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = body;
            
            const icon = document.getElementById('modal-icon');
            icon.className = `w-12 h-12 mx-auto text-${iconColor}-500`;

            // Simple switch to pick the right icon based on color/context
            if (iconColor === 'green') {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            } else if (iconColor === 'orange') {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            }

            document.getElementById('info-modal').classList.remove('hidden');
        }

        /**
         * Hides the custom modal message box.
         */
        window.closeModal = function() {
            document.getElementById('info-modal').classList.add('hidden');
        }

    </script>
</body>
</html>
